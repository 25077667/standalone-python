name: "release"

on: {
    "push": {
        "branches": ["master"],
    }
}

jobs: {
    release: {
        "runs-on": "ubuntu-latest",
        "strategy": {
            "matrix": {
                "architecture": ["x86_64", "x86"],
                "version": ["3.11"],
            },
        },
        "steps": [
            {
                "name": "Checkout code",
                "uses": "actions/checkout@v3",
            },
            {
                "name": "Build docker image",
                "run": "docker build -t release-${{ github.ref_name }}:${{ matrix.architecture }}.${{ matrix.version }} ./${{ matrix.version }}/${{ matrix.architecture }}/",
            },
            {
                "name": "Save docker image as tar file",
                "run": "docker save release-${{ github.ref_name }}:${{ matrix.architecture }}.${{ matrix.version }} > release-${{ matrix.architecture }}.${{ matrix.version }}.tar",
            },
            {
                "name": "Figure out the /opt/python directory from the tar file",
                "run": "tar -xf release-${{ matrix.architecture }}.${{ matrix.version }}.tar -C /tmp && cd /tmp && tar -xf $(ls -S | head -n 1) && zip -r -9 release-${{ matrix.architecture }}.${{ matrix.version }}.zip opt/python",
            },
            {
                "name": "Release the tar file to release page",
                "uses": "actions/upload-artifact@v3",
                "with": {
                    "name": "release-${{ matrix.architecture }}.${{ matrix.version }}.zip",
                    "path": "release-${{ matrix.architecture }}.${{ matrix.version }}.zip",
                },
            },
        ],
    }
}
